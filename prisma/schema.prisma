generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  MANAGER
  CLIENT
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  WON
  LOST
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum WorkOrderStatus {
  BACKLOG
  SCHEDULED
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELED
}

enum InvoiceStatus {
  DRAFT
  SENT
  PARTIAL
  PAID
  OVERDUE
  VOID
}

enum EstimateStatus {
  DRAFT
  SENT
  APPROVED
  REJECTED
  EXPIRED
  CONVERTED
}

enum EmployeeRole {
  FIELD_TECH
  SUPERVISOR
  ACCOUNT_MANAGER
  DISPATCH
  COORDINATOR
}

enum EmployeeStatus {
  ACTIVE
  ON_LEAVE
  INACTIVE
}

enum ScheduleStatus {
  SCHEDULED
  DISPATCHED
  IN_PROGRESS
  COMPLETED
  CANCELED
}

enum ActivitySeverity {
  INFO
  SUCCESS
  WARNING
  URGENT
}

model User {
  id           String        @id @default(cuid())
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  username     String        @unique
  passwordHash String
  role         UserRole      @default(CLIENT)
  fullName     String?
  clientId     String?
  client       Client?       @relation(fields: [clientId], references: [id], onDelete: SetNull)
  sessions     Session[]
  activityLogs ActivityLog[]

  @@index([role])
}

model Session {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tokenHash String   @unique
  expiresAt DateTime
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([userId])
}

model Lead {
  id            String     @id @default(cuid())
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  name          String
  email         String
  phone         String?
  company       String?
  serviceNeeded String?
  message       String
  source        String     @default("website")
  status        LeadStatus @default(NEW)
  estimates     Estimate[]

  @@index([createdAt])
  @@index([status])
}

model Client {
  id            String         @id @default(cuid())
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  companyName   String
  contactName   String
  email         String
  phone         String
  tier          String
  properties    Property[]
  workOrders    WorkOrder[]
  invoices      Invoice[]
  users         User[]
  estimates     Estimate[]
  scheduleItems ScheduleItem[]
  activityLogs  ActivityLog[]

  @@index([companyName])
}

model Property {
  id            String         @id @default(cuid())
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  name          String
  addressLine1  String
  city          String
  state         String
  zipCode       String
  managerName   String
  managerEmail  String
  managerPhone  String
  clientId      String?
  client        Client?        @relation(fields: [clientId], references: [id], onDelete: SetNull)
  workOrders    WorkOrder[]
  estimates     Estimate[]
  scheduleItems ScheduleItem[]

  @@index([city, state])
}

model WorkOrder {
  id                  String          @id @default(cuid())
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  code                String          @unique
  title               String
  description         String
  status              WorkOrderStatus @default(BACKLOG)
  priority            Priority        @default(MEDIUM)
  assignee            String?
  assignedEmployeeId  String?
  assignedEmployee    Employee?       @relation("AssignedEmployeeWorkOrders", fields: [assignedEmployeeId], references: [id], onDelete: SetNull)
  estimatedHours      Int?
  actualHours         Int?
  estimatedValueCents Int?
  locationLabel       String?
  scheduledFor        DateTime?
  completedAt         DateTime?
  clientId            String?
  client              Client?         @relation(fields: [clientId], references: [id], onDelete: SetNull)
  propertyId          String?
  property            Property?       @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  invoices            Invoice[]
  estimates           Estimate[]
  scheduleItems       ScheduleItem[]

  @@index([status])
  @@index([priority])
  @@index([scheduledFor])
}

model Invoice {
  id            String        @id @default(cuid())
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  invoiceNumber String        @unique
  amountCents   Int
  status        InvoiceStatus @default(DRAFT)
  issuedAt      DateTime      @default(now())
  dueDate       DateTime
  paidAt        DateTime?
  notes         String?
  clientId      String
  client        Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  workOrderId   String?
  workOrder     WorkOrder?    @relation(fields: [workOrderId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([dueDate])
}

model Estimate {
  id                   String         @id @default(cuid())
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  estimateNumber       String         @unique
  title                String
  description          String
  amountCents          Int
  status               EstimateStatus @default(DRAFT)
  validUntil           DateTime?
  preparedBy           String?
  notes                String?
  clientId             String?
  client               Client?        @relation(fields: [clientId], references: [id], onDelete: SetNull)
  propertyId           String?
  property             Property?      @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  leadId               String?
  lead                 Lead?          @relation(fields: [leadId], references: [id], onDelete: SetNull)
  convertedWorkOrderId String?
  convertedWorkOrder   WorkOrder?     @relation(fields: [convertedWorkOrderId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([validUntil])
}

model Employee {
  id            String         @id @default(cuid())
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  fullName      String
  email         String         @unique
  phone         String
  role          EmployeeRole
  status        EmployeeStatus @default(ACTIVE)
  avatarUrl     String?
  territory     String?
  workOrders    WorkOrder[]    @relation("AssignedEmployeeWorkOrders")
  scheduleItems ScheduleItem[]

  @@index([role])
  @@index([status])
}

model ScheduleItem {
  id          String         @id @default(cuid())
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  title       String
  serviceType String
  startAt     DateTime
  endAt       DateTime
  status      ScheduleStatus @default(SCHEDULED)
  location    String
  notes       String?
  employeeId  String?
  employee    Employee?      @relation(fields: [employeeId], references: [id], onDelete: SetNull)
  workOrderId String?
  workOrder   WorkOrder?     @relation(fields: [workOrderId], references: [id], onDelete: SetNull)
  clientId    String?
  client      Client?        @relation(fields: [clientId], references: [id], onDelete: SetNull)
  propertyId  String?
  property    Property?      @relation(fields: [propertyId], references: [id], onDelete: SetNull)

  @@index([startAt])
  @@index([status])
}

model ActivityLog {
  id          String           @id @default(cuid())
  createdAt   DateTime         @default(now())
  actorName   String
  action      String
  entityType  String
  entityId    String?
  description String
  severity    ActivitySeverity @default(INFO)
  userId      String?
  user        User?            @relation(fields: [userId], references: [id], onDelete: SetNull)
  clientId    String?
  client      Client?          @relation(fields: [clientId], references: [id], onDelete: SetNull)

  @@index([createdAt])
  @@index([severity])
}

model GalleryAsset {
  id         String   @id @default(cuid())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  title      String
  caption    String
  category   String
  imageUrl   String
  featured   Boolean  @default(false)
  capturedAt DateTime @default(now())
  location   String

  @@index([category])
  @@index([featured])
}

model ServicePackage {
  id               String   @id @default(cuid())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  slug             String   @unique
  name             String
  summary          String
  responseSlaHours Int
  coverageArea     String
  startingPrice    String
  featured         Boolean  @default(false)

  @@index([featured])
}
