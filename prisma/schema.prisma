generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  MANAGER
  CLIENT
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  WON
  LOST
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum WorkOrderStatus {
  BACKLOG
  SCHEDULED
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELED
}

enum InvoiceStatus {
  DRAFT
  SENT
  PARTIAL
  PAID
  OVERDUE
  VOID
}

enum EstimateStatus {
  DRAFT
  SENT
  APPROVED
  REJECTED
  EXPIRED
  CONVERTED
}

enum EmployeeRole {
  FIELD_TECH
  SUPERVISOR
  ACCOUNT_MANAGER
  DISPATCH
  COORDINATOR
}

enum EmployeeStatus {
  ACTIVE
  ON_LEAVE
  INACTIVE
}

enum ScheduleStatus {
  SCHEDULED
  DISPATCHED
  IN_PROGRESS
  COMPLETED
  CANCELED
}

enum ActivitySeverity {
  INFO
  SUCCESS
  WARNING
  URGENT
}

enum OnboardingStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  BLOCKED
}

enum ContactStatus {
  ACTIVE
  INACTIVE
  DO_NOT_CONTACT
}

enum BookingStatus {
  NEW
  REVIEWED
  QUOTED
  WON
  CLOSED
}

enum CheckInType {
  CLOCK_IN
  CLOCK_OUT
  ON_MY_WAY
  ARRIVED
  COMPLETE
}

enum ChannelType {
  EMAIL
  SMS
}

enum CampaignStatus {
  ACTIVE
  PAUSED
  DISABLED
}

enum MessageStatus {
  QUEUED
  SENT
  FAILED
  CANCELED
}

enum PaymentStatus {
  PENDING
  SETTLED
  FAILED
  REFUNDED
  VOID
}

enum PayrollStatus {
  DRAFT
  APPROVED
  PROCESSED
  CANCELED
}

enum AvailabilityType {
  AVAILABLE
  BLOCKED
  TIME_OFF
  PTO
}

enum IntegrationStatus {
  CONNECTED
  DISCONNECTED
  ERROR
  PENDING
}

enum ExportStatus {
  QUEUED
  COMPLETED
  FAILED
}

model User {
  id           String        @id @default(cuid())
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  username     String        @unique
  passwordHash String
  role         UserRole      @default(CLIENT)
  fullName     String?
  clientId     String?
  client       Client?       @relation(fields: [clientId], references: [id], onDelete: SetNull)
  sessions     Session[]
  activityLogs ActivityLog[]

  @@index([role])
}

model Session {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tokenHash String   @unique
  expiresAt DateTime
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([userId])
}

model Lead {
  id              String           @id @default(cuid())
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  name            String
  email           String
  phone           String?
  company         String?
  serviceNeeded   String?
  message         String
  source          String           @default("website")
  status          LeadStatus       @default(NEW)
  estimates       Estimate[]
  bookingRequests BookingRequest[] @relation("BookingConvertedLead")

  @@index([createdAt])
  @@index([status])
}

model Client {
  id              String           @id @default(cuid())
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  companyName     String
  contactName     String
  email           String
  phone           String
  tier            String
  properties      Property[]
  workOrders      WorkOrder[]
  invoices        Invoice[]
  users           User[]
  estimates       Estimate[]
  scheduleItems   ScheduleItem[]
  activityLogs    ActivityLog[]
  onboardingTasks OnboardingTask[]
  contacts        ContactPerson[]
  bookingRequests BookingRequest[]
  automationRules AutomationRule[]
  messageLogs     MessageLog[]

  @@index([companyName])
}

model Property {
  id            String         @id @default(cuid())
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  name          String
  addressLine1  String
  city          String
  state         String
  zipCode       String
  managerName   String
  managerEmail  String
  managerPhone  String
  clientId      String?
  client        Client?        @relation(fields: [clientId], references: [id], onDelete: SetNull)
  workOrders    WorkOrder[]
  estimates     Estimate[]
  scheduleItems ScheduleItem[]

  @@index([city, state])
}

model WorkOrder {
  id                  String          @id @default(cuid())
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  code                String          @unique
  title               String
  description         String
  status              WorkOrderStatus @default(BACKLOG)
  priority            Priority        @default(MEDIUM)
  assignee            String?
  assignedEmployeeId  String?
  assignedEmployee    Employee?       @relation("AssignedEmployeeWorkOrders", fields: [assignedEmployeeId], references: [id], onDelete: SetNull)
  estimatedHours      Int?
  actualHours         Int?
  estimatedValueCents Int?
  locationLabel       String?
  scheduledFor        DateTime?
  completedAt         DateTime?
  clientId            String?
  client              Client?         @relation(fields: [clientId], references: [id], onDelete: SetNull)
  propertyId          String?
  property            Property?       @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  invoices            Invoice[]
  estimates           Estimate[]
  scheduleItems       ScheduleItem[]

  @@index([status])
  @@index([priority])
  @@index([scheduledFor])
}

model Invoice {
  id            String          @id @default(cuid())
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  invoiceNumber String          @unique
  amountCents   Int
  status        InvoiceStatus   @default(DRAFT)
  issuedAt      DateTime        @default(now())
  dueDate       DateTime
  paidAt        DateTime?
  notes         String?
  clientId      String
  client        Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  workOrderId   String?
  workOrder     WorkOrder?      @relation(fields: [workOrderId], references: [id], onDelete: SetNull)
  payments      PaymentRecord[]

  @@index([status])
  @@index([dueDate])
}

model Estimate {
  id                   String         @id @default(cuid())
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  estimateNumber       String         @unique
  title                String
  description          String
  amountCents          Int
  status               EstimateStatus @default(DRAFT)
  validUntil           DateTime?
  preparedBy           String?
  notes                String?
  clientId             String?
  client               Client?        @relation(fields: [clientId], references: [id], onDelete: SetNull)
  propertyId           String?
  property             Property?      @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  leadId               String?
  lead                 Lead?          @relation(fields: [leadId], references: [id], onDelete: SetNull)
  convertedWorkOrderId String?
  convertedWorkOrder   WorkOrder?     @relation(fields: [convertedWorkOrderId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([validUntil])
}

model Employee {
  id                 String              @id @default(cuid())
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  fullName           String
  email              String              @unique
  phone              String
  role               EmployeeRole
  status             EmployeeStatus      @default(ACTIVE)
  avatarUrl          String?
  territory          String?
  workOrders         WorkOrder[]         @relation("AssignedEmployeeWorkOrders")
  scheduleItems      ScheduleItem[]
  checkIns           FieldCheckIn[]
  payrollEntries     PayrollEntry[]
  availabilityBlocks AvailabilityBlock[]

  @@index([role])
  @@index([status])
}

model ScheduleItem {
  id          String         @id @default(cuid())
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  title       String
  serviceType String
  startAt     DateTime
  endAt       DateTime
  status      ScheduleStatus @default(SCHEDULED)
  location    String
  notes       String?
  employeeId  String?
  employee    Employee?      @relation(fields: [employeeId], references: [id], onDelete: SetNull)
  workOrderId String?
  workOrder   WorkOrder?     @relation(fields: [workOrderId], references: [id], onDelete: SetNull)
  clientId    String?
  client      Client?        @relation(fields: [clientId], references: [id], onDelete: SetNull)
  propertyId  String?
  property    Property?      @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  checkIns    FieldCheckIn[]

  @@index([startAt])
  @@index([status])
}

model ActivityLog {
  id          String           @id @default(cuid())
  createdAt   DateTime         @default(now())
  actorName   String
  action      String
  entityType  String
  entityId    String?
  description String
  severity    ActivitySeverity @default(INFO)
  userId      String?
  user        User?            @relation(fields: [userId], references: [id], onDelete: SetNull)
  clientId    String?
  client      Client?          @relation(fields: [clientId], references: [id], onDelete: SetNull)

  @@index([createdAt])
  @@index([severity])
}

model GalleryAsset {
  id         String   @id @default(cuid())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  title      String
  caption    String
  category   String
  imageUrl   String
  featured   Boolean  @default(false)
  capturedAt DateTime @default(now())
  location   String

  @@index([category])
  @@index([featured])
}

model ServicePackage {
  id               String   @id @default(cuid())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  slug             String   @unique
  name             String
  summary          String
  responseSlaHours Int
  coverageArea     String
  startingPrice    String
  featured         Boolean  @default(false)

  @@index([featured])
}

model OnboardingTask {
  id          String           @id @default(cuid())
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  title       String
  owner       String?
  status      OnboardingStatus @default(PENDING)
  dueDate     DateTime?
  completedAt DateTime?
  notes       String?
  clientId    String?
  client      Client?          @relation(fields: [clientId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([dueDate])
}

model ContactPerson {
  id        String        @id @default(cuid())
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  fullName  String
  email     String
  phone     String?
  title     String?
  status    ContactStatus @default(ACTIVE)
  isPrimary Boolean       @default(false)
  isBilling Boolean       @default(false)
  notes     String?
  clientId  String
  client    Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([status])
}

model BookingRequest {
  id              String        @id @default(cuid())
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  name            String
  email           String
  phone           String?
  company         String?
  address         String?
  serviceType     String
  frequency       String?
  preferredDate   DateTime?
  source          String        @default("website-booking")
  status          BookingStatus @default(NEW)
  notes           String?
  convertedLeadId String?
  convertedLead   Lead?         @relation("BookingConvertedLead", fields: [convertedLeadId], references: [id], onDelete: SetNull)
  clientId        String?
  client          Client?       @relation(fields: [clientId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([preferredDate])
}

model FieldCheckIn {
  id             String        @id @default(cuid())
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  type           CheckInType
  latitude       Float?
  longitude      Float?
  notes          String?
  employeeId     String
  employee       Employee      @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  scheduleItemId String?
  scheduleItem   ScheduleItem? @relation(fields: [scheduleItemId], references: [id], onDelete: SetNull)

  @@index([employeeId, createdAt])
  @@index([type])
}

model AutomationRule {
  id               String         @id @default(cuid())
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  name             String
  channel          ChannelType
  triggerEvent     String
  sendAfterMinutes Int            @default(0)
  templateSubject  String?
  templateBody     String
  status           CampaignStatus @default(ACTIVE)
  clientId         String?
  client           Client?        @relation(fields: [clientId], references: [id], onDelete: SetNull)
  logs             MessageLog[]

  @@index([status])
  @@index([triggerEvent])
}

model MessageLog {
  id           String          @id @default(cuid())
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  recipient    String
  channel      ChannelType
  subject      String?
  body         String
  status       MessageStatus   @default(QUEUED)
  scheduledFor DateTime?
  sentAt       DateTime?
  campaignId   String?
  campaign     AutomationRule? @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  clientId     String?
  client       Client?         @relation(fields: [clientId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([scheduledFor])
}

model PaymentRecord {
  id                String        @id @default(cuid())
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  amountCents       Int
  processor         String
  externalReference String?
  status            PaymentStatus @default(PENDING)
  paidAt            DateTime?
  notes             String?
  invoiceId         String
  invoice           Invoice       @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([status])
}

model PaymentProcessor {
  id                   String   @id @default(cuid())
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  name                 String   @unique
  enabled              Boolean  @default(false)
  sandboxMode          Boolean  @default(true)
  publishableKeyMasked String?
  webhookUrl           String?
  notes                String?
}

model PayrollRun {
  id              String         @id @default(cuid())
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  periodStart     DateTime
  periodEnd       DateTime
  status          PayrollStatus  @default(DRAFT)
  totalGrossCents Int            @default(0)
  processedAt     DateTime?
  notes           String?
  entries         PayrollEntry[]

  @@index([periodStart, periodEnd])
  @@index([status])
}

model PayrollEntry {
  id            String     @id @default(cuid())
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  payrollRunId  String
  payrollRun    PayrollRun @relation(fields: [payrollRunId], references: [id], onDelete: Cascade)
  employeeId    String
  employee      Employee   @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  hoursWorked   Int
  baseRateCents Int
  bonusCents    Int        @default(0)
  grossCents    Int
  notes         String?

  @@index([payrollRunId])
  @@index([employeeId])
}

model AvailabilityBlock {
  id         String           @id @default(cuid())
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  startAt    DateTime
  endAt      DateTime
  type       AvailabilityType @default(BLOCKED)
  reason     String?
  approved   Boolean          @default(false)
  employeeId String
  employee   Employee         @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId, startAt])
  @@index([type])
}

model IntegrationConnection {
  id                  String            @id @default(cuid())
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  provider            String            @unique
  status              IntegrationStatus @default(DISCONNECTED)
  apiKeyMasked        String?
  webhookUrl          String?
  syncIntervalMinutes Int               @default(15)
  lastSyncAt          DateTime?
  notes               String?

  @@index([status])
}

model PlanTier {
  id                String   @id @default(cuid())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  code              String   @unique
  name              String
  monthlyPriceCents Int
  maxUsers          Int
  maxClients        Int
  maxProperties     Int
  apiAccess         Boolean  @default(false)
  mobileAccess      Boolean  @default(false)
  automationAccess  Boolean  @default(false)
}

model ExportJob {
  id          String       @id @default(cuid())
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  resource    String
  format      String       @default("csv")
  status      ExportStatus @default(QUEUED)
  requestedBy String?
  downloadUrl String?
  completedAt DateTime?
  notes       String?

  @@index([resource, status])
}
